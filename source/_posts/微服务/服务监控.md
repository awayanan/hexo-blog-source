---
title: 服务监控
categories:
  - 微服务
tags:
  - 代码治理
  - 服务监控
date: 2023-02-25 13:22:20
---
>服务监控是保证生产环境稳定最基础的也是最重要的措施，没有成熟的监控方案微服务化注定是失败的结局。

## 敬畏线上
>线上故障虽迟但到。

但是做好服务的事前监控、容错以及服务降级，是可以尽量减少故障发生的概率以及降低故障所带来的影响。
简单评估一下服务发生风险所带来的危害性：
$$风险的危害性=故障发生的可能性 * 故障发生后的严重性$$
![](/images/fault.png)

最怕的就是故障突然间的雪崩式爆发，所以啊，一定要对服务建立善的监控体系，尽可能发现故障的征兆，提早预防，做好容错和降级。

### 服务熔断
当一个服务因为各种原因停止响应时，调用方通常会等待一段时间，然后超时或者收到错误返回。如果调用链路比较长，可能会导致请求堆积，整条链路占用大量资源一直在等待下游响应。
所以当多次访问一个服务失败时，应熔断，标记该服务已停止工作，直接返回错误。直至该服务恢复正常后再重新建立连接。
![](https://img2018.cnblogs.com/blog/576869/201908/576869-20190822202623628-671154877.png)

### 服务降级
服务降级一般是指在服务器压力剧增的时候，根据实际业务使用情况以及流量，
对一些服务和页面有策略的不处理或者用一种简单的方式进行处理，从而释放服务器资源的资源以保证核心业务的正常高效运行。

### 服务降级 VS 服务熔断

- 触发原因不一样，服务熔断一般是某个服务（下游服务）故障引起，而服务降级一般是从整体负荷考虑；
- 管理目标层次不一样，服务熔断是一个框架层次的处理，服务降级是业务层次的处理；
- 实现方式不一样，服务熔断一般是自我熔断恢复，服务降级相当于人工控制； 


### 限流
一个服务挂掉后，上游服务或者用户一般会习惯性地重试访问。这导致一旦服务恢复正常，很可能因为瞬间网络流量过大又立刻挂掉，在棺材里重复着仰卧起坐。
因此服务需要能够自我保护——限流。限流策略有很多，最简单的比如当单位时间内请求数过多时，丢弃多余的请求。另外，也可以考虑分区限流。仅拒绝来自产生大量请求的服务的请求。

### 总结

>限流：限制并发的请求访问量，超过阈值则拒绝；

>降级：服务分优先级，牺牲非核心服务（不可用），保证核心服务稳定；从整体负荷考虑；

>熔断：依赖的下游服务故障触发熔断，避免引发本系统崩溃；系统自动执行和恢复

## 监控指标

### 性能指标
性能指标：
- ResponseTime - RT：响应时间，用户从客户端发起一个请求开始计算，到客户端接收到服务端的响应结束，整个过程所耗费的时间。
- MaxRT：最大响应时间，指用户发出请求到服务端返回响应的最大时间。
- MinRT：最少响应时间，指用户发出请求到服务端返回响应的最少时间。
- Hits Per Second - HPS：用户每秒点击次数，即每秒向后台发送的请求次数。
- QPS：系统每秒处理查询的次数。
- 99%响应时间 - TOP99：将所有用户的响应时间进行升序排序，取99%的位置。

性能测试关注点：
- CPU使用率
- 内存使用情况
- 吞吐量：每秒钟系统能处理的请求数、任务数。
- 响应时间：服务处理一个请求或者一个任务的耗时。
- 错误率：一批请求中结果出过错的请求所占比例。
